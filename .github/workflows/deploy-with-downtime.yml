name: ğŸ›‘ Deploy COM Downtime (Teste CientÃ­fico)

on:
  workflow_dispatch:
    inputs:
      downtime_duration:
        description: "DuraÃ§Ã£o do downtime em segundos"
        required: false
        default: "180"
      mfe_target:
        description: "MFE para atualizar"
        required: false
        default: "all"
        type: choice
        options:
          - container
          - catalog
          - cart
          - all

jobs:
  deploy-with-downtime:
    runs-on: ubuntu-latest
    name: ğŸ›‘ Deploy COM Downtime

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§ª Simular Downtime para Teste CientÃ­fico
        run: |
          echo "ğŸ§ª SIMULANDO DOWNTIME PARA TESTE CIENTÃFICO"
          echo "â° DuraÃ§Ã£o: ${{ github.event.inputs.downtime_duration }}s"
          echo "ğŸ¯ MFE alvo: ${{ github.event.inputs.mfe_target }}"
          echo "ğŸ›‘ AplicaÃ§Ã£o serÃ¡ parada para simular downtime real..."

          # Simular downtime
          sleep ${{ github.event.inputs.downtime_duration }}

          echo "âœ… Downtime simulado concluÃ­do"

      - name: ğŸ—ï¸ Build MFEs
        run: |
          # Build do MFE especificado
          if [ "${{ github.event.inputs.mfe_target }}" = "container" ] || [ "${{ github.event.inputs.mfe_target }}" = "all" ]; then
            echo "ğŸ  Build Container MFE..."
            cd lgs-mfe-container
            npm ci
            npm run build
            cd ..
          fi

          if [ "${{ github.event.inputs.mfe_target }}" = "catalog" ] || [ "${{ github.event.inputs.mfe_target }}" = "all" ]; then
            echo "ğŸ“š Build Catalog MFE..."
            cd lgs-mfe-catalog
            npm ci
            npm run build
            cd ..
          fi

          if [ "${{ github.event.inputs.mfe_target }}" = "cart" ] || [ "${{ github.event.inputs.mfe_target }}" = "all" ]; then
            echo "ğŸ›’ Build Cart MFE..."
            cd lgs-mfe-cart
            npm ci
            npm run build
            cd ..
          fi

      - name: ğŸ“ Preparar docs
        run: |
          # Copiar builds para docs
          if [ "${{ github.event.inputs.mfe_target }}" = "container" ] || [ "${{ github.event.inputs.mfe_target }}" = "all" ]; then
            mkdir -p docs/container
            cp -r lgs-mfe-container/dist/lgs-mfe-container/* docs/container/
          fi

          if [ "${{ github.event.inputs.mfe_target }}" = "catalog" ] || [ "${{ github.event.inputs.mfe_target }}" = "all" ]; then
            mkdir -p docs/catalog
            cp -r lgs-mfe-catalog/dist/lgs-mfe-catalog/* docs/catalog/
          fi

          if [ "${{ github.event.inputs.mfe_target }}" = "cart" ] || [ "${{ github.event.inputs.mfe_target }}" = "all" ]; then
            mkdir -p docs/cart
            cp -r lgs-mfe-cart/dist/lgs-mfe-cart/* docs/cart/
          fi

      - name: ğŸ“ Atualizar VersÃ£o
        run: |
          echo "ğŸ“ Atualizando versÃ£o para indicar deploy..."
          echo "v$(date +%s)" > docs/version.txt
          echo "Deploy com downtime: ${{ github.event.inputs.downtime_duration }}s" >> docs/deploy-info.txt

      - name: ğŸš€ Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: true

      - name: ğŸ“Š Status do Deploy
        run: |
          echo "âœ… Deploy com downtime concluÃ­do"
          echo "â° Downtime: ${{ github.event.inputs.downtime_duration }}s"
          echo "ğŸ¯ MFE atualizado: ${{ github.event.inputs.mfe_target }}"
          echo "ğŸ“ˆ UptimeRobot deve detectar interrupÃ§Ã£o"
          echo "ğŸ§ª Teste cientÃ­fico executado com sucesso"

      - name: ğŸ”” Notificar ConclusÃ£o
        run: |
          echo "ğŸ”” Deploy cientÃ­fico concluÃ­do em: $(date)"
          echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ“Š Verifique UptimeRobot para dados de downtime"
